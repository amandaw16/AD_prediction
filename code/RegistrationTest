#!/bin/bash


#---------------- Folder Arrangement -----------------#
#                                                     #
#                                       |- train      #
#         		 	  |- Data|- test       #
# ~/home/elec5622/AD_prediction  |- Packages          #
#         		          |- Output|- train    #
#                                         |- test     #
#                                                     #
#-----------------------------------------------------#      


root_path='/home/elec5622/AD_prediction'
data_root=$root_path'/Data/'
package_DIR=$root_path'/Packages/'

output_path=$root_path'/Output/'
train_output_path=$root_path'/Output/train/'
test_output_path=$root_path'/Output/test/'
floImg=$package_DIR'MNI152_T1_1mm_brain.nii.gz'
aalImg=$package_DIR'aal.nii.gz'
brain_imgs_train=$root_path'/Output/brain_imgs_train'
brain_imgs_test=$root_path'/Output/brain_imgs_test'

#====================  registration =======================#
echo "=============== begin registration... ========"

#---- process training images
#-----these are the extracted brain images in the train folder of Output folder
cd $test_output_path
echo "===========Printing the current directory ======"
pwd

# ---- retrieve only the brain files to a folder called brain_imgs_train
find "$test_output_path" -type f \( -name "AD_*_brain.nii.gz" -o -name "NC_*_brain.nii.gz" \) -exec mv {} "$brain_imgs_test" \;
test_brain_imgs=$(find "$brain_imgs_test" -type f)

# ----only for training -----
for subID in $test_brain_imgs; 
do
   	echo "Processing testing image "$subID
     	refImg=$subID

     fileext='.nii.gz'
     file=$subID
     basename $file $fileext
     filename="${file%%.*}"
	#affine registration
     	echo "Register MNI template using affine transform"
     	reg_aladin -ref $file -flo $floImg -res ${filename}_MNI152_T1_native_affine.nii.gz -aff ${filename}_MNI2Native_affine.txt
	#TODO
     #deformable registration
     	echo "Register MNI template using deformable transform"
	#TODO
	reg_f3d -ref $file -flo $floImg -aff ${filename}_MNI2Native_affine.txt -res ${filename}_MNI152_T1_native_warp.nii.gz -cpp ${filename}_warpcoeff.nii.gz
     #transform AAL atlas
    	#TODO
    	reg_resample -ref $file -flo $aalImg -res ${filename}_transformed_aal.nii.gz -trans ${filename}_warpcoeff.nii.gz -inter 0 
     #remove files no longer needed
	#TODO
done
